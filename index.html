<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HORARI ROCA ¬∑ Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ESTILS GENERALS */
    body { font-family: system-ui, sans-serif; margin: 0; background: #f3f4f6; }
    .hidden { display: none !important; }
    
    /* LOGIN */
    .login-screen { display: flex; align-items: center; justify-content: center; height: 100vh; background: #764ba2; }
    .login-box { background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 350px; }

    /* BARRA D'USUARI I ADMIN */
    .user-bar { background: #1f2937; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    .admin-controls { background: #fff; padding: 15px 20px; border-bottom: 2px solid #e5e7eb; display: none; gap: 10px; }
    
    /* ROLS */
    .role-badge { font-size: 11px; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; margin-left: 10px; font-weight: bold; }
    .role-admin { background: #ef4444; color: white; }
    .role-encarregat { background: #f59e0b; color: white; }
    .role-treballador { background: #10b981; color: white; }

    /* APLICACI√ì */
    .app-container { padding: 20px; }
    .worker-list { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .holiday-alert { color: #ef4444; font-weight: bold; margin-left: 10px; font-size: 0.9em; }
    
    button { cursor: pointer; padding: 8px 15px; border-radius: 6px; border: none; font-weight: 600; }
    .btn-add { background: #10b981; color: white; }
    .btn-holiday { background: #ef4444; color: white; }
  </style>
</head>
<body>

  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <h2 style="text-align: center;">üóìÔ∏è Horari Roca</h2>
      <form id="authForm">
        <input type="email" id="email" placeholder="Correu electr√≤nic" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
        <input type="password" id="password" placeholder="Contrasenya" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <button type="submit" style="width: 100%; background: #1f2937; color: white; padding: 10px;">Iniciar sessi√≥</button>
      </form>
    </div>
  </div>

  <div id="mainApp" class="hidden">
    <div class="user-bar">
      <div>
        <strong>Horari Roca</strong>
        <span id="userEmail" style="margin-left: 15px; opacity: 0.8;"></span>
        <span id="userRoleBadge" class="role-badge"></span>
      </div>
      <button onclick="logout()" style="background: #374151; color: white; font-size: 12px;">Tancar sessi√≥</button>
    </div>

    <div id="adminPanel" class="admin-controls">
      <button class="btn-add" onclick="addNewWorker()">+ Afegir Treballador</button>
      <input type="date" id="holidayPicker" style="padding: 7px; border: 1px solid #ccc; border-radius: 5px; margin-left: 10px;">
      <button class="btn-holiday" onclick="toggleHoliday()">Marcar/Desmarcar Festiu</button>
    </div>

    <div class="app-container">
      <div class="worker-list">
        <h3>Treballadors actius</h3>
        <div id="workersList">Carregant treballadors...</div>
      </div>
      <div id="calendarDisplay">
        <p>Graella d'horaris configurada per al rol: <strong id="currentRoleText"></strong></p>
      </div>
    </div>
  </div>

  <script>
    // 1. CONFIGURACI√ì
    const SUPABASE_URL = 'https://zwxismquyhyeufdmtgsw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3eGlzbXF1eWh5ZXVmZG10Z3N3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzYxODYsImV4cCI6MjA4MTkxMjE4Nn0.ewU3PFuJoW8UfaK6jZqvqjm9PJ0s5citTjd9Xuzypt0';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let userRole = 'treballador';

    // 2. INICIALITZACI√ì I LOGIN
    document.getElementById('authForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert("Error de login: " + error.message);
      else location.reload();
    });

    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        currentUser = session.user;
        await loadRole();
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('userEmail').textContent = currentUser.email;
        loadWorkers();
      }
    }

    // 3. GESTI√ì DE ROLS
    async function loadRole() {
      const { data, error } = await supabase.from('profiles').select('role').eq('id', currentUser.id).single();
      if (data) {
        userRole = data.role;
        const badge = document.getElementById('userRoleBadge');
        badge.textContent = userRole;
        badge.className = `role-badge role-${userRole}`;
        document.getElementById('currentRoleText').textContent = userRole;
        
        if (userRole === 'admin') document.getElementById('adminPanel').style.display = 'flex';
      }
    }

    // 4. TREBALLADORS I COLORS
    async function loadWorkers() {
      const { data, error } = await supabase.from('workers').select('*').eq('user_id', currentUser.id);
      const list = document.getElementById('workersList');
      list.innerHTML = '';
      
      if (data) {
        data.forEach(w => {
          const div = document.createElement('div');
          div.style.padding = "8px";
          div.style.marginBottom = "5px";
          div.style.borderLeft = `5px solid ${w.color}`;
          div.style.background = "#f9fafb";
          div.innerHTML = `<strong>${w.name}</strong> <small style="color:#666; margin-left:10px;">${w.color}</small>`;
          list.appendChild(div);
        });
      }
    }

    async function addNewWorker() {
      if (userRole !== 'admin') return;
      const name = prompt("Nom del treballador:");
      const color = prompt("Color hex (ex: #3b82f6):", "#3b82f6");
      if (name && color) {
        await supabase.from('workers').insert([{ name, color, user_id: currentUser.id }]);
        loadWorkers();
      }
    }

    async function toggleHoliday() {
      const date = document.getElementById('holidayPicker').value;
      if (!date) return alert("Selecciona una data primer");
      
      // L√≤gica per desar festiu a la taula 'holidays'
      const { error } = await supabase.from('holidays').insert([{ date, user_id: currentUser.id }]);
      if (error) {
        // Si ja existeix, l'esborrem (toggle)
        await supabase.from('holidays').delete().eq('date', date).eq('user_id', currentUser.id);
        alert("Festiu eliminat");
      } else {
        alert("Festiu marcat correctament");
      }
    }

    async function logout() {
      await supabase.auth.signOut();
      location.reload();
    }

    checkSession();
  </script>
</body>
</html>