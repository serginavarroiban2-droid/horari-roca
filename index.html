<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HORARI ROCA ¬∑ Planner</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; }
    
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
    }

    /* ========== LOGIN SCREEN ========== */
    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 400px;
      margin: 20px;
    }

    .login-box h1 {
      margin: 0 0 8px;
      font-size: 28px;
      color: #1f2937;
      text-align: center;
    }

    .login-box p {
      margin: 0 0 24px;
      color: #6b7280;
      text-align: center;
      font-size: 14px;
    }

    .login-box input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 12px;
      transition: border-color 0.2s;
    }

    .login-box input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-box button {
      width: 100%;
      padding: 12px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .login-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -10px rgba(102, 126, 234, 0.5);
    }

    .login-box button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .login-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
    }

    /* ========== LOADING OVERLAY ========== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    /* ========== USER BAR ========== */
    .user-bar {
      background: #1f2937;
      color: white;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
    }

    .user-bar .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-bar .user-avatar {
      width: 28px;
      height: 28px;
      background: #667eea;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
    }

    .user-bar button {
      background: #374151;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .user-bar button:hover {
      background: #4b5563;
    }

    .save-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #9ca3af;
    }

    .save-indicator.saving {
      color: #fbbf24;
    }

    .save-indicator.saved {
      color: #10b981;
    }

    .save-indicator.error {
      color: #ef4444;
    }

    .app {
      display: flex;
      height: calc(100vh - 44px);
      height: calc(100dvh - 44px);
    }

    /* ========== DESKTOP/TABLET NORMAL ========== */
    .left {
      width: 240px;
      border-right: 2px solid #9ca3af;
      background: #fff;
      padding: 10px;
      overflow-y: auto;
    }

    .right {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 10px;
      min-width: 0;
      min-height: 0;
    }

    h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .workers-info {
      font-size: 11px;
      color: #6b7280;
      margin: 0 0 6px;
    }

    .worker-row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 6px;
    }

    .worker-row input[type="checkbox"] {
      margin: 0;
    }

    .worker-row.selected .worker {
      box-shadow: 0 0 0 2px #111827;
    }

    .worker {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: grab;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      position: relative;
    }

    .worker:active { cursor: grabbing; }

    .worker-color {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    #summary {
      margin-top: 10px;
      font-size: 11px;
    }

    #summary h3 {
      margin: 6px 0 4px;
      font-size: 12px;
    }

    #summary table {
      width: 100%;
      border-collapse: collapse;
    }

    #summary th, #summary td {
      padding: 2px 4px;
      text-align: left;
    }

    #summary th {
      border-bottom: 1px solid #d1d5db;
      font-weight: 600;
    }

    #summary td.hours {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .top-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      flex-wrap: wrap;
    }

    .top-bar input[type="date"] {
      font-size: 13px;
      padding: 2px 4px;
    }

    #weekDate.holiday-week {
      border-color: #ef4444;
      background: #fee2e2;
    }

    #weekBanner {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: #111827;
    }

    .week-wrapper {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.08);
      padding: 10px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
    }

    .week-grid-wrapper {
      flex: 1;
      min-height: 0;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      position: relative;
    }

    .week-grid {
      display: grid;
      grid-auto-rows: 26px;
      background: #fff;
      border-radius: 6px;
      border: 2px solid #9ca3af;
      overflow: hidden;
      height: 100%;
      min-height: 0;
      min-width: 800px;
    }

    .cell {
      border: 1px solid #f3f4f6;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      background: #fff;
      position: relative;
    }

    .cell.header-day {
      background: #dbeafe;
      font-weight: 600;
      font-size: 12px;
      color: #111827;
      border-bottom: 2px solid #9ca3af;
    }

    .cell.header-day.holiday-day {
      background: #fecaca;
      color: #7f1d1d;
    }

    .cell.hour-cell {
      background: #e5e7eb;
      justify-content: flex-end;
      align-items: flex-start;
      padding-right: 3px;
      padding-top: 2px;
      color: #374151;
      font-size: 11px;
      border-right: 2px solid #9ca3af;
    }

    .cell.slot-cell {
      background: #ffffff;
      cursor: pointer;
    }

    .cell.slot-cell.holiday-slot {
      background: #fef2f2;
    }

    .cell.slot-cell.drop-target {
      background: #e0f2fe;
      box-shadow: inset 0 0 0 1px #60a5fa;
    }

    .narrow-col {
      background: #f9fafb;
    }

    .day-separator {
      border-right: 2px solid #9ca3af !important;
    }

    .shift-block {
      border-radius: 6px;
      font-size: 10px;
      padding: 2px 4px;
      display: flex;
      flex-direction: column;
      gap: 1px;
      border: 1px solid #3b82f6;
      position: relative;
      cursor: move;
    }

    .shift-block.moving {
      opacity: 0.85;
      pointer-events: none;
    }

    .shift-block.editing {
      animation: pulse 1s ease-in-out infinite;
      z-index: 100;
      box-shadow: 0 0 0 3px #3b82f6;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .edit-handle {
      position: absolute;
      width: 60px;
      height: 60px;
      background: #3b82f6;
      border: 4px solid #fff;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 32px;
      font-weight: bold;
      cursor: grab;
      z-index: 200;
      touch-action: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      user-select: none;
      -webkit-user-select: none;
    }

    .shift-block.editing .edit-handle {
      display: flex !important;
    }

    .edit-handle.top {
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
    }

    .edit-handle.bottom {
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
    }

    .edit-handle.top:active {
      background: #2563eb;
      transform: translateX(-50%) scale(1.15);
      cursor: grabbing;
    }

    .edit-handle.bottom:active {
      background: #2563eb;
      transform: translateX(-50%) rotate(180deg) scale(1.15);
      cursor: grabbing;
    }

    .shift-main-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
      min-width: 0;
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      z-index: 10;
      pointer-events: none;
    }

    .shift-main {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #111827;
      padding: 0 2px;
      text-align: center;
      pointer-events: none;
    }

    .shift-note {
      font-size: 9px;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 2px;
    }

    .handle {
      position: absolute;
      left: 0;
      right: 0;
      height: 8px;
      cursor: ns-resize;
      user-select: none;
      z-index: 10;
    }

    .handle.top { top: 0; }
    .handle.bottom { bottom: 0; }

    .handle::after {
      content: '';
      display: block;
      margin: 0 auto;
      width: 60%;
      height: 2px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.35);
    }

    .shift-del {
      border: none;
      background: rgba(239, 68, 68, 0.95);
      color: #fff;
      cursor: pointer;
      font-size: 18px;
      padding: 6px 10px;
      min-width: 32px;
      height: 32px;
      z-index: 11;
      border-radius: 6px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .shift-del:active {
      background: #dc2626;
      transform: scale(1.1);
    }

    .bottom-bar {
      display: flex;
      align-items: center;
      font-size: 11px;
      margin-top: 4px;
      gap: 6px;
      flex-wrap: wrap;
    }

    .bottom-bar button {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }

    .report-controls {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
      font-size: 11px;
    }

    .report-controls input[type="date"] {
      font-size: 11px;
      padding: 2px 4px;
    }

    #status {
      font-size: 11px;
      color: #059669;
      margin-left: auto;
      min-height: 14px;
    }

    .red-line {
      border-top: 2px solid #ef4444 !important;
    }

    /* ========== IMPRESSI√ì ========== */
    @media print {
      @page { size: A4 landscape; }
      body { background: #fff; }
      .left, .bottom-bar, .user-bar { display: none !important; }
      .right { padding: 0; }
      .app { height: auto; }
      .week-wrapper {
        box-shadow: none;
        padding: 0;
        height: auto;
      }
      .top-bar { margin-bottom: 2px; }
      #weekBanner { font-size: 10px; }
      .week-grid {
        border-width: 1px;
        height: calc(100vh - 40px);
        grid-auto-rows: 22px !important;
      }
      .cell { font-size: 9px; }
      .cell.header-day { font-size: 10px; }
      .cell.hour-cell { font-size: 9px; }
      .shift-main, .shift-note { font-size: 8px; }
    }

    /* ========== M√íBIL HORITZONTAL (LANDSCAPE) ========== */
    @media screen and (orientation: landscape) and (max-height: 500px) {
      
      body {
        margin: 0;
        padding: 0;
      }

      .app {
        flex-direction: row !important;
        height: calc(100vh - 44px);
        height: calc(100dvh - 44px);
      }

      .left {
        width: 80px !important;
        padding: 4px 2px !important;
        border-right: 1px solid #d1d5db !important;
        background: #fafafa !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 4px !important;
      }

      h2, .workers-info, #summary {
        display: none !important;
      }

      #workers {
        display: flex !important;
        flex-direction: column !important;
        gap: 6px !important;
        padding: 4px 0 !important;
      }

      .worker-row {
        margin: 0 !important;
        flex-direction: column !important;
        align-items: center !important;
      }

      .worker-row input[type="checkbox"] {
        display: none !important;
      }

      .worker {
        width: 70px !important;
        height: 70px !important;
        border-radius: 50% !important;
        padding: 0 !important;
        border-width: 2px !important;
        flex: none !important;
        font-size: 0 !important;
        background: #e5e7eb !important;
      }

      .worker-row.selected .worker {
        border-width: 3px !important;
        border-color: #111827 !important;
        box-shadow: 0 0 0 2px #111827 !important;
      }

      .worker-color {
        width: 100% !important;
        height: 100% !important;
        border-radius: 50% !important;
        opacity: 1 !important;
      }

      .worker span {
        display: none !important;
      }

      .worker::after {
        content: attr(data-initials) !important;
        position: absolute !important;
        inset: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 18px !important;
        font-weight: 700 !important;
        color: #111827 !important;
        pointer-events: none !important;
      }

      .right {
        flex: 1 !important;
        padding: 0 !important;
        gap: 0 !important;
        min-width: 0 !important;
      }

      .top-bar {
        padding: 3px 6px !important;
        background: #f9fafb !important;
        border-bottom: 1px solid #d1d5db !important;
        gap: 6px !important;
        font-size: 10px !important;
        min-height: 28px !important;
        flex-shrink: 0 !important;
      }

      .top-bar label {
        font-size: 9px !important;
        gap: 3px !important;
      }

      .top-bar input[type="date"] {
        font-size: 10px !important;
        padding: 2px 3px !important;
      }

      #weekBanner {
        font-size: 9px !important;
      }

      .bottom-bar {
        display: none !important;
      }

      .week-wrapper {
        flex: 1 !important;
        padding: 0 !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        gap: 0 !important;
        min-height: 0 !important;
        overflow: hidden !important;
      }

      .week-grid-wrapper {
        flex: 1 !important;
        overflow: auto !important;
        -webkit-overflow-scrolling: touch !important;
        min-height: 0 !important;
        height: 100% !important;
        overscroll-behavior: contain !important;
        position: relative !important;
      }

      .week-grid {
        grid-auto-rows: 30px !important;
        border: none !important;
        border-radius: 0 !important;
        min-width: 0 !important;
        height: auto !important;
        min-height: 100% !important;
        touch-action: pan-x pan-y !important;
      }

      .cell {
        font-size: 10px !important;
      }

      .cell.header-day {
        font-size: 11px !important;
      }

      .cell.hour-cell {
        font-size: 10px !important;
      }

      .shift-block {
        font-size: 11px !important;
        padding: 4px 6px !important;
        border-width: 2px !important;
      }

      .shift-main {
        font-size: 10px !important;
      }

      .shift-note {
        font-size: 9px !important;
      }

      .shift-del {
        font-size: 20px !important;
        min-width: 30px !important;
        padding: 4px !important;
      }

      .handle {
        height: 16px !important;
      }

      .handle::after {
        height: 4px !important;
        width: 50% !important;
      }
    }

    /* ========== M√íBIL VERTICAL (PORTRAIT) ========== */
    @media screen and (orientation: portrait) and (max-width: 600px) {
      
      body {
        margin: 0;
        padding: 0;
      }

      .app {
        flex-direction: column !important;
        height: calc(100vh - 44px);
        height: calc(100dvh - 44px);
      }

      .left {
        width: 100% !important;
        height: 80px !important;
        padding: 4px !important;
        border-right: none !important;
        border-bottom: 1px solid #d1d5db !important;
        background: #fafafa !important;
        display: flex !important;
        flex-direction: row !important;
        gap: 6px !important;
        overflow-x: auto !important;
        overflow-y: hidden !important;
      }

      h2, .workers-info, #summary {
        display: none !important;
      }

      #workers {
        display: flex !important;
        flex-direction: row !important;
        gap: 8px !important;
        padding: 0 !important;
        align-items: center !important;
      }

      .worker-row {
        margin: 0 !important;
        flex-direction: column !important;
        align-items: center !important;
        flex-shrink: 0 !important;
      }

      .worker-row input[type="checkbox"] {
        display: none !important;
      }

      .worker {
        width: 65px !important;
        height: 65px !important;
        border-radius: 50% !important;
        padding: 0 !important;
        border-width: 2px !important;
        flex: none !important;
        font-size: 0 !important;
        background: #e5e7eb !important;
      }

      .worker-row.selected .worker {
        border-width: 3px !important;
        border-color: #111827 !important;
        box-shadow: 0 0 0 2px #111827 !important;
      }

      .worker-color {
        width: 100% !important;
        height: 100% !important;
        border-radius: 50% !important;
        opacity: 1 !important;
      }

      .worker span {
        display: none !important;
      }

      .worker::after {
        content: attr(data-initials) !important;
        position: absolute !important;
        inset: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 16px !important;
        font-weight: 700 !important;
        color: #111827 !important;
        pointer-events: none !important;
      }

      .right {
        flex: 1 !important;
        padding: 0 !important;
        gap: 0 !important;
        min-width: 0 !important;
        min-height: 0 !important;
      }

      .top-bar {
        padding: 4px 8px !important;
        background: #f9fafb !important;
        border-bottom: 1px solid #d1d5db !important;
        gap: 6px !important;
        font-size: 11px !important;
        min-height: 32px !important;
        flex-shrink: 0 !important;
      }

      .top-bar label {
        font-size: 10px !important;
        gap: 3px !important;
      }

      .top-bar input[type="date"] {
        font-size: 11px !important;
        padding: 2px 4px !important;
      }

      #weekBanner {
        font-size: 10px !important;
      }

      .bottom-bar {
        display: none !important;
      }

      .week-wrapper {
        flex: 1 !important;
        padding: 0 !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        gap: 0 !important;
        min-height: 0 !important;
        overflow: hidden !important;
      }

      .week-grid-wrapper {
        flex: 1 !important;
        overflow: auto !important;
        -webkit-overflow-scrolling: touch !important;
        min-height: 0 !important;
        height: 100% !important;
        overscroll-behavior: contain !important;
        position: relative !important;
      }

      .week-grid {
        grid-auto-rows: 32px !important;
        border: none !important;
        border-radius: 0 !important;
        min-width: 900px !important;
        height: auto !important;
        min-height: 100% !important;
        touch-action: pan-x pan-y !important;
      }

      .cell {
        font-size: 10px !important;
      }

      .cell.header-day {
        font-size: 11px !important;
      }

      .cell.hour-cell {
        font-size: 10px !important;
      }

      .shift-block {
        font-size: 10px !important;
        padding: 3px 5px !important;
        border-width: 2px !important;
      }

      .shift-main {
        font-size: 9px !important;
      }

      .shift-note {
        font-size: 8px !important;
      }

      .shift-del {
        font-size: 18px !important;
        min-width: 28px !important;
        padding: 4px !important;
      }

      .handle {
        height: 14px !important;
      }

      .handle::after {
        height: 3px !important;
        width: 50% !important;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <script>
    // Timeout de seguretat - si en 10 segons no carrega, amaga el loading
    setTimeout(() => {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay && !overlay.classList.contains('hidden')) {
        overlay.classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        console.error('Timeout: La connexi√≥ ha trigat massa');
      }
    }, 10000);
  </script>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen hidden">
    <div class="login-box">
      <h1>üóìÔ∏è Horari Roca</h1>
      <p>Planificador de torns</p>

      <div id="loginError" class="login-error"></div>

      <form id="authForm" onsubmit="handleLogin(event)">
        <input type="email" id="email" placeholder="Correu electr√≤nic" required>
        <input type="password" id="password" placeholder="Contrasenya" required>
        <button type="submit" id="authButton">Iniciar sessi√≥</button>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden">
    <div class="user-bar">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">U</div>
        <span id="userEmail">usuari@example.com</span>
      </div>
      <div class="save-indicator" id="saveIndicator">
        <span>‚óè</span> <span id="saveText">Desat</span>
      </div>
      <button onclick="logout()">Tancar sessi√≥</button>
    </div>

    <div class="app">
      <div class="left">
        <h2>Treballadors</h2>
        <p class="workers-info">
          Marcar/desmarcar selecciona el treballador per veure'l a la graella i als resums.<br>
          Arrossega el bloc per crear torns a la graella. Doble clic en un torn per afegir nota.
        </p>

        <div id="workers"></div>

        <div id="summary">
          <h3>Resum hores setmana</h3>
          <div id="summaryContent">Cap torn encara.</div>
        </div>
      </div>

      <div class="right">
        <div class="top-bar">
          <label>
            Setmana (data de refer√®ncia):
            <input type="date" id="weekDate">
          </label>
          <span id="weekBanner"></span>
        </div>

        <div class="week-wrapper">
          <div class="week-grid-wrapper">
            <div class="week-grid" id="weekGrid"></div>
          </div>
          <div class="bottom-bar">
            <div class="report-controls">
              <label>Resum de:
                <input type="date" id="reportFrom">
              </label>
              <span>fins</span>
              <label>
                <input type="date" id="reportTo">
              </label>
              <button id="reportBtn">Resum hores (PDF)</button>
            </div>

            <button id="copyBtn">Copiar setmana</button>
            <button id="pasteBtn">Enganxar setmana</button>
            <button id="printBtn">Imprimir setmana</button>
            <button id="clearBtn">Netejar setmana</button>
            <div id="status"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURACI√ì SUPABASE ==========
    // IMPORTANT: Canvia aquestes credencials per les teves!
    const SUPABASE_URL = 'https://zwxismquyhyeufdmtgsw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3eGlzbXF1eWh5ZXVmZG10Z3N3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzYxODYsImV4cCI6MjA4MTkxMjE4Nn0.ewU3PFuJoW8UfaK6jZqvqjm9PJ0s5citTjd9Xuzypt0';

    let supabaseClient;
    let currentUser = null;

    // ========== CONSTANTS ==========
    const HOUR_START = 7;
    const HOUR_END = 22;
    const SLOT_MINUTES = 30;
    const SLOTS_PER_HOUR = 60 / SLOT_MINUTES;
    const TOTAL_SLOTS = (HOUR_END - HOUR_START) * SLOTS_PER_HOUR;
    const MIN_SLOTS_CREATE = 5 * SLOTS_PER_HOUR;
    const MIN_SLOTS_RESIZE = 1;
    let slotHeightRuntime = 26;

    const DAYS = ['Dilluns', 'Dimarts', 'Dimecres', 'Dijous', 'Divendres', 'Dissabte', 'Diumenge'];
    const LANES_PER_DAY = 5;

    // Default workers (si no n'hi ha a la base de dades)
    const DEFAULT_WORKERS = [
      { name: 'Joan Garcia', color: '#ef4444', selected: true },
      { name: 'Maria L√≥pez', color: '#f59e0b', selected: true },
      { name: 'Pere Mart√≠', color: '#10b981', selected: true },
      { name: 'Anna Serra', color: '#3b82f6', selected: true },
      { name: 'Carles Puig', color: '#8b5cf6', selected: true }
    ];

    let workers = [];
    let shifts = [];
    let nextId = 1;
    let resizing = null;
    let moving = null;
    let currentWeekStart = null;
    let copiedWeek = null;
    let weekHolidays = [];
    let editingShiftId = null;
    let longPressTimer = null;
    let saveTimeout = null;
    let isSaving = false;

    const isMobileDevice = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) || 
                           window.innerWidth <= 900 || 
                           ('ontouchstart' in window);

    // ========== INICIALITZACI√ì ==========
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Comprovar que les credencials estan configurades
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
          document.getElementById('loadingOverlay').classList.add('hidden');
          alert('ERROR: Has de configurar les credencials de Supabase!\n\nObre index.html i canvia SUPABASE_URL i SUPABASE_ANON_KEY');
          return;
        }

        // Inicialitzar Supabase
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Comprovar si hi ha sessi√≥ activa
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error) {
          console.error('Error de sessi√≥:', error);
          showLoginScreen();
          return;
        }
        
        if (session) {
          currentUser = session.user;
          showMainApp();
        } else {
          showLoginScreen();
        }

        // Escoltar canvis d'autenticaci√≥
        supabaseClient.auth.onAuthStateChange((event, session) => {
          if (event === 'SIGNED_IN' && session) {
            currentUser = session.user;
            showMainApp();
          } else if (event === 'SIGNED_OUT') {
            currentUser = null;
            showLoginScreen();
          }
        });
      } catch (error) {
        console.error('Error inicialitzant:', error);
        document.getElementById('loadingOverlay').classList.add('hidden');
        alert('Error connectant amb Supabase: ' + error.message);
      }
    });

    // ========== AUTENTICACI√ì ==========
    async function handleLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const loginError = document.getElementById('loginError');
      const authButton = document.getElementById('authButton');

      loginError.style.display = 'none';
      authButton.disabled = true;
      authButton.textContent = 'Entrant...';

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });

        if (error) throw error;
      } catch (error) {
        let errorMsg = error.message;
        if (error.message.includes('Invalid login credentials')) {
          errorMsg = 'Correu o contrasenya incorrectes';
        } else if (error.message.includes('Email not confirmed')) {
          errorMsg = 'Compte no activat. Contacta amb l\'administrador.';
        }
        loginError.textContent = errorMsg;
        loginError.style.display = 'block';
      } finally {
        authButton.disabled = false;
        authButton.textContent = 'Iniciar sessi√≥';
      }
    }

    async function logout() {
      await supabaseClient.auth.signOut();
    }

    function showLoginScreen() {
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    function showMainApp() {
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');

      // Mostrar info usuari
      const email = currentUser.email;
      document.getElementById('userEmail').textContent = email;
      document.getElementById('userAvatar').textContent = email.charAt(0).toUpperCase();

      // Inicialitzar l'app
      initializeApp();
    }

    function initializeApp() {
      const weekInput = document.getElementById('weekDate');
      const todayIso = new Date().toISOString().slice(0,10);
      weekInput.value = todayIso;

      document.getElementById('clearBtn').addEventListener('click', clearShifts);
      document.getElementById('copyBtn').addEventListener('click', copyWeek);
      document.getElementById('pasteBtn').addEventListener('click', pasteWeek);
      document.getElementById('printBtn').addEventListener('click', () => window.print());
      document.getElementById('reportBtn').addEventListener('click', generateReport);

      weekInput.addEventListener('change', loadWeek);

      buildWeekGrid();
      loadWeek();

      document.addEventListener('pointermove', onPointerMoveGlobal);
      document.addEventListener('pointerup', onPointerUpGlobal);
      document.addEventListener('pointercancel', onPointerUpGlobal);

      if (isMobileDevice) {
        document.addEventListener('click', (e) => {
          if (!editingShiftId) return;
          const grid = document.getElementById('weekGrid');
          if (!grid.contains(e.target)) {
            exitEditMode();
          }
        });
      }

      window.addEventListener('resize', adjustSlotHeight);
      adjustSlotHeight();
    }

    // ========== SUPABASE DATA FUNCTIONS ==========
    async function loadWorkersFromSupabase() {
      const { data, error } = await supabaseClient
        .from('workers')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('name');

      if (error) {
        console.error('Error carregant treballadors:', error);
        return DEFAULT_WORKERS;
      }

      if (!data || data.length === 0) {
        // Crear treballadors per defecte si no n'hi ha
        await createDefaultWorkers();
        return DEFAULT_WORKERS.map(w => ({ ...w, selected: true }));
      }

      return data.map(w => ({
        name: w.name,
        color: w.color,
        selected: true
      }));
    }

    async function createDefaultWorkers() {
      const workersToInsert = DEFAULT_WORKERS.map(w => ({
        user_id: currentUser.id,
        name: w.name,
        color: w.color
      }));

      await supabaseClient.from('workers').insert(workersToInsert);
    }

    async function loadHolidaysFromSupabase() {
      const { data, error } = await supabaseClient
        .from('holidays')
        .select('date')
        .eq('user_id', currentUser.id);

      if (error) {
        console.error('Error carregant festius:', error);
        return [];
      }

      return data ? data.map(h => h.date) : [];
    }

    async function loadShiftsFromSupabase(weekStart) {
      const weekEnd = new Date(parseISODate(weekStart));
      weekEnd.setDate(weekEnd.getDate() + 6);

      const { data, error } = await supabaseClient
        .from('shifts')
        .select('*')
        .eq('user_id', currentUser.id)
        .gte('date', weekStart)
        .lte('date', formatISO(weekEnd));

      if (error) {
        console.error('Error carregant torns:', error);
        return [];
      }

      return data || [];
    }

    async function saveShiftsToSupabase() {
      if (!currentUser || !currentWeekStart) return;

      isSaving = true;
      updateSaveIndicator('saving');

      try {
        const weekEnd = new Date(parseISODate(currentWeekStart));
        weekEnd.setDate(weekEnd.getDate() + 6);

        // Eliminar torns existents d'aquesta setmana
        await supabaseClient
          .from('shifts')
          .delete()
          .eq('user_id', currentUser.id)
          .gte('date', currentWeekStart)
          .lte('date', formatISO(weekEnd));

        // Inserir els nous torns
        if (shifts.length > 0) {
          const shiftsToInsert = shifts.map(s => {
            const shiftDate = new Date(parseISODate(currentWeekStart));
            shiftDate.setDate(shiftDate.getDate() + s.dayIndex);

            return {
              user_id: currentUser.id,
              worker_name: s.worker,
              date: formatISO(shiftDate),
              start_time: slotToTime(s.startSlot),
              end_time: slotToTime(s.endSlot),
              note: s.note || ''
            };
          });

          const { error } = await supabaseClient.from('shifts').insert(shiftsToInsert);
          if (error) throw error;
        }

        updateSaveIndicator('saved');
      } catch (error) {
        console.error('Error desant:', error);
        updateSaveIndicator('error');
      } finally {
        isSaving = false;
      }
    }

    function updateSaveIndicator(status) {
      const indicator = document.getElementById('saveIndicator');
      const text = document.getElementById('saveText');

      indicator.className = 'save-indicator ' + status;

      switch (status) {
        case 'saving':
          text.textContent = 'Desant...';
          break;
        case 'saved':
          text.textContent = 'Desat';
          break;
        case 'error':
          text.textContent = 'Error al desar';
          break;
      }
    }

    function scheduleAutoSave() {
      if (saveTimeout) {
        clearTimeout(saveTimeout);
      }
      
      updateSaveIndicator('saving');
      
      saveTimeout = setTimeout(() => {
        saveShiftsToSupabase();
      }, 1000); // Desar despr√©s d'1 segon d'inactivitat
    }

    // ========== FUNCIONS AUXILIARS ==========
    function setStatus(msg, isError) {
      const el = document.getElementById('status');
      if (!el) return;
      el.textContent = msg;
      el.style.color = isError ? '#ef4444' : '#059669';
    }

    function formatHoursFromMinutes(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      if (m === 0) return `${h} h`;
      return `${h} h ${m} min`;
    }

    function formatHoursFromSlots(slots) {
      const mins = slots * 30;
      return formatHoursFromMinutes(mins);
    }

    function isWorkerSelected(name) {
      const w = workers.find(x => x.name === name);
      if (!w) return true;
      return w.selected !== false;
    }

    function getSelectedWorkerNames() {
      return workers.filter(w => w.selected !== false).map(w => w.name);
    }

    function parseISODate(iso) {
      const [y, m, d] = iso.split('-').map(Number);
      return new Date(y, m - 1, d);
    }

    function formatISO(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function formatWeekBanner(startDate) {
      const endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + 6);
      const months = ['gener','febrer','mar√ß','abril','maig','juny','juliol','agost','setembre','octubre','novembre','desembre'];

      const sDay = startDate.getDate();
      const eDay = endDate.getDate();
      const sMonth = startDate.getMonth();
      const eMonth = endDate.getMonth();

      if (sMonth === eMonth) {
        const monthName = months[sMonth].toUpperCase();
        return `SETMANA DEL ${sDay} AL ${eDay} DE ${monthName}`;
      } else {
        const m1 = months[sMonth].toUpperCase();
        const m2 = months[eMonth].toUpperCase();
        return `SETMANA DEL ${sDay} DE ${m1} AL ${eDay} DE ${m2}`;
      }
    }

    function updateSummary() {
      const box = document.getElementById('summaryContent');
      if (!box) return;
      const visible = shifts.filter(s => isWorkerSelected(s.worker));

      if (!visible.length) {
        box.textContent = 'Cap torn encara.';
        return;
      }

      const totalsSlots = {};
      visible.forEach(s => {
        const durSlots = s.endSlot - s.startSlot;
        totalsSlots[s.worker] = (totalsSlots[s.worker] || 0) + durSlots;
      });

      const workersNames = Object.keys(totalsSlots).sort();
      if (!workersNames.length) {
        box.textContent = 'Cap torn encara.';
        return;
      }

      let html = '<table><tr><th>Treballador</th><th style="text-align:right;">Hores</th></tr>';
      workersNames.forEach(name => {
        html += `<tr><td>${name}</td><td class="hours">${formatHoursFromSlots(totalsSlots[name])}</td></tr>`;
      });
      html += '</table>';

      box.innerHTML = html;
    }

    function renderWorkers() {
      const cont = document.getElementById('workers');
      if (!cont) return;
      cont.innerHTML = '';

      if (!workers || workers.length === 0) {
        cont.innerHTML = '<div style="padding: 10px; color: #ef4444; font-size: 12px;">‚ö†Ô∏è No hi ha treballadors.</div>';
        return;
      }

      workers.forEach(w => {
        if (typeof w.selected === 'undefined') w.selected = true;

        const row = document.createElement('div');
        row.className = 'worker-row';
        if (w.selected) row.classList.add('selected');

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = w.selected;
        chk.addEventListener('change', e => {
          w.selected = e.target.checked;
          renderWorkers();
          renderShifts();
        });

        const div = document.createElement('div');
        div.className = 'worker';
        div.draggable = true;
        div.dataset.worker = w.name;

        const parts = w.name.split(' ');
        const initials = (parts[0]?.charAt(0) || '') + (parts[1]?.charAt(0) || '');
        div.dataset.initials = initials.toUpperCase();

        const dot = document.createElement('span');
        dot.className = 'worker-color';
        dot.style.backgroundColor = w.color || '#3b82f6';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = w.name;

        div.appendChild(dot);
        div.appendChild(nameSpan);

        chk.addEventListener('pointerdown', e => e.stopPropagation());
        chk.addEventListener('click', e => e.stopPropagation());

        div.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', w.name);
        });

        div.addEventListener('click', () => {
          w.selected = !w.selected;
          renderWorkers();
          renderShifts();
        });

        row.appendChild(chk);
        row.appendChild(div);
        cont.appendChild(row);
      });
    }

    function buildWeekGrid() {
      const grid = document.getElementById('weekGrid');
      if (!grid) return;
      grid.innerHTML = '';

      const cols = ['30px'];
      for (let d = 0; d < DAYS.length; d++) {
        for (let lane = 0; lane < LANES_PER_DAY; lane++) {
          cols.push(lane === LANES_PER_DAY - 1 ? '0.6fr' : '1fr');
        }
      }
      grid.style.gridTemplateColumns = cols.join(' ');

      const corner = document.createElement('div');
      corner.className = 'cell';
      corner.style.gridRow = '1';
      corner.style.gridColumn = '1';
      corner.style.position = 'sticky';
      corner.style.left = '0';
      corner.style.top = '0';
      corner.style.zIndex = '4';
      corner.style.background = '#fff';
      grid.appendChild(corner);

      for (let d = 0; d < DAYS.length; d++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'cell header-day';
        dayCell.textContent = DAYS[d];
        dayCell.dataset.dayIndex = String(d);

        const startCol = 2 + d * LANES_PER_DAY;
        dayCell.style.gridRow = '1';
        dayCell.style.gridColumn = `${startCol} / span ${LANES_PER_DAY}`;
        dayCell.classList.add('day-separator');
        dayCell.style.position = 'sticky';
        dayCell.style.top = '0';
        dayCell.style.zIndex = '2';

        grid.appendChild(dayCell);
      }

      const hoursCount = HOUR_END - HOUR_START;
      const slot15 = (15 - HOUR_START) * SLOTS_PER_HOUR;

      for (let i = 0; i < hoursCount; i++) {
        const hour = HOUR_START + i;
        const rowStart = 2 + i * SLOTS_PER_HOUR;
        const hourCell = document.createElement('div');
        hourCell.className = 'cell hour-cell';
        hourCell.textContent = `${hour}:00`;
        hourCell.style.gridRow = `${rowStart} / span ${SLOTS_PER_HOUR}`;
        hourCell.style.gridColumn = '1';
        hourCell.style.position = 'sticky';
        hourCell.style.left = '0';
        hourCell.style.zIndex = '3';
        hourCell.style.background = '#e5e7eb';
        if (hour === 15) hourCell.classList.add('red-line');
        grid.appendChild(hourCell);
      }

      for (let slot = 0; slot < TOTAL_SLOTS; slot++) {
        const rowIndex = 2 + slot;
        for (let d = 0; d < DAYS.length; d++) {
          for (let lane = 0; lane < LANES_PER_DAY; lane++) {
            const col = 2 + d * LANES_PER_DAY + lane;
            const cell = document.createElement('div');
            cell.className = 'cell slot-cell';
            cell.style.gridRow = String(rowIndex);
            cell.style.gridColumn = String(col);

            cell.dataset.day = String(d);
            cell.dataset.lane = String(lane);
            cell.dataset.slot = String(slot);

            if (lane === LANES_PER_DAY - 1) {
              cell.classList.add('narrow-col', 'day-separator');
            }
            if (slot === slot15) {
              cell.classList.add('red-line');
            }

            cell.addEventListener('dragover', e => {
              e.preventDefault();
              cell.classList.add('drop-target');
            });
            cell.addEventListener('dragleave', () => {
              cell.classList.remove('drop-target');
            });
            cell.addEventListener('drop', e => {
              e.preventDefault();
              cell.classList.remove('drop-target');
              const workerName = e.dataTransfer.getData('text/plain');
              if (workerName) {
                const dayIndex = parseInt(cell.dataset.day, 10);
                const laneIndex = parseInt(cell.dataset.lane, 10);
                const slotIndex = parseInt(cell.dataset.slot, 10);
                createShift(workerName, dayIndex, laneIndex, slotIndex);
              }
            });

            if (isMobileDevice) {
              cell.addEventListener('click', (e) => {
                e.stopPropagation();
                if (editingShiftId) {
                  const dayIndex = parseInt(cell.dataset.day, 10);
                  const laneIndex = parseInt(cell.dataset.lane, 10);
                  const slotIndex = parseInt(cell.dataset.slot, 10);
                  moveShiftToCell(dayIndex, laneIndex, slotIndex);
                }
              });
            }

            grid.appendChild(cell);
          }
        }
      }
    }

    function adjustSlotHeight() {
      const grid = document.getElementById('weekGrid');
      if (!grid) return;

      const isLandscape = window.matchMedia('(orientation: landscape) and (max-height: 500px)').matches;
      const isPortrait = window.matchMedia('(orientation: portrait) and (max-width: 600px)').matches;
      
      if (isLandscape) {
        slotHeightRuntime = 30;
        grid.style.gridAutoRows = '30px';
        return;
      }
      
      if (isPortrait) {
        slotHeightRuntime = 32;
        grid.style.gridAutoRows = '32px';
        return;
      }

      const wrapper = grid.parentElement;
      if (!wrapper) return;
      const rect = wrapper.getBoundingClientRect();
      const available = rect.height - 10;
      if (available <= 0) return;

      const slotHeight = Math.max(18, Math.floor(available / (TOTAL_SLOTS + 2)));
      grid.style.gridAutoRows = slotHeight + 'px';
      slotHeightRuntime = slotHeight;
    }

    function updateWeekHeaderAndHolidays(weekStartStr, holidays) {
      if (!weekStartStr) return;
      const startDate = parseISODate(weekStartStr);
      const holidaySet = new Set(holidays || []);

      const bannerEl = document.getElementById('weekBanner');
      if (bannerEl) bannerEl.textContent = formatWeekBanner(startDate);

      const weekInput = document.getElementById('weekDate');
      if (weekInput) {
        if (holidaySet.size > 0) weekInput.classList.add('holiday-week');
        else weekInput.classList.remove('holiday-week');
      }

      const headers = document.querySelectorAll('.header-day');
      headers.forEach(el => {
        const dayIndex = parseInt(el.dataset.dayIndex, 10);
        const d = new Date(startDate);
        d.setDate(d.getDate() + dayIndex);
        const iso = formatISO(d);
        const dayNum = d.getDate();
        el.textContent = `${DAYS[dayIndex]} ${dayNum}`;
        if (holidaySet.has(iso)) el.classList.add('holiday-day');
        else el.classList.remove('holiday-day');
      });

      const cells = document.querySelectorAll('.slot-cell');
      cells.forEach(cell => {
        const dayIndex = parseInt(cell.dataset.day, 10);
        const d = new Date(startDate);
        d.setDate(d.getDate() + dayIndex);
        const iso = formatISO(d);
        if (holidaySet.has(iso)) cell.classList.add('holiday-slot');
        else cell.classList.remove('holiday-slot');
      });
    }

    async function loadWeek() {
      const weekDateStr = document.getElementById('weekDate').value;
      
      setStatus('Carregant setmana...', false);

      try {
        // Carregar treballadors
        workers = await loadWorkersFromSupabase();
        
        // Carregar festius
        const allHolidays = await loadHolidaysFromSupabase();
        
        // Calcular l'inici de setmana (dilluns)
        const inputDate = parseISODate(weekDateStr);
        const dayOfWeek = inputDate.getDay();
        const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        const weekStart = new Date(inputDate);
        weekStart.setDate(inputDate.getDate() + diff);
        currentWeekStart = formatISO(weekStart);

        // Calcular festius d'aquesta setmana
        weekHolidays = [];
        for (let i = 0; i < 7; i++) {
          const d = new Date(weekStart);
          d.setDate(d.getDate() + i);
          const iso = formatISO(d);
          if (allHolidays.includes(iso)) {
            weekHolidays.push(iso);
          }
        }

        // Actualitzar dates del report
        document.getElementById('weekDate').value = currentWeekStart;
        const d2 = new Date(weekStart);
        d2.setDate(d2.getDate() + 6);
        document.getElementById('reportFrom').value = currentWeekStart;
        document.getElementById('reportTo').value = formatISO(d2);

        renderWorkers();

        // Carregar torns
        const shiftsData = await loadShiftsFromSupabase(currentWeekStart);
        shifts = [];
        nextId = 1;

        shiftsData.forEach(s => {
          const dayIndex = daysBetween(currentWeekStart, s.date);
          if (dayIndex < 0 || dayIndex > 6) return;

          const startSlot = timeToSlot(s.start_time);
          const endSlot = timeToSlot(s.end_time);
          if (isNaN(startSlot) || isNaN(endSlot) || endSlot <= startSlot) return;

          let laneIndex = 0;
          for (let lane = 0; lane < LANES_PER_DAY; lane++) {
            if (!hasOverlap(dayIndex, lane, startSlot, endSlot, null)) {
              laneIndex = lane;
              break;
            }
          }

          const w = workers.find(x => x.name === s.worker_name);
          const color = w ? (w.color || '#3b82f6') : '#3b82f6';

          const id = nextId++;
          shifts.push({
            id,
            worker: s.worker_name,
            color,
            dayIndex,
            laneIndex,
            startSlot,
            endSlot,
            note: s.note || ''
          });
        });

        renderShifts();
        updateWeekHeaderAndHolidays(currentWeekStart, weekHolidays);
        adjustSlotHeight();

        setStatus('‚úÖ Setmana carregada', false);
        updateSaveIndicator('saved');
      } catch (error) {
        console.error('Error carregant setmana:', error);
        setStatus('‚ùå Error carregant: ' + error.message, true);
      }
    }

    function daysBetween(startStr, dateStr) {
      const start = parseISODate(startStr);
      const d = parseISODate(dateStr);
      const msPerDay = 24 * 60 * 60 * 1000;
      start.setHours(0,0,0,0);
      d.setHours(0,0,0,0);
      return Math.round((d - start) / msPerDay);
    }

    function timeToSlot(timeStr) {
      if (!timeStr) return NaN;
      const parts = String(timeStr).split(':');
      if (parts.length < 2) return NaN;
      const h = parseInt(parts[0], 10);
      const m = parseInt(parts[1], 10) || 0;
      const total = h * 60 + m;
      const offset = total - HOUR_START * 60;
      const slot = offset / SLOT_MINUTES;
      if (slot < 0 || slot > TOTAL_SLOTS) return NaN;
      return slot;
    }

    function createShift(workerName, dayIndex, laneIndex, startSlot) {
      let endSlot = startSlot + MIN_SLOTS_CREATE;
      if (endSlot > TOTAL_SLOTS) {
        endSlot = TOTAL_SLOTS;
        if (endSlot - startSlot < MIN_SLOTS_CREATE) {
          setStatus('No hi ha prou espai per un torn de 5 hores en aquesta posici√≥.', true);
          return;
        }
      }
      if (hasOverlap(dayIndex, laneIndex, startSlot, endSlot, null)) {
        setStatus('Ja hi ha un torn en aquesta franja.', true);
        return;
      }

      const w = workers.find(x => x.name === workerName);
      const color = w ? (w.color || '#3b82f6') : '#3b82f6';

      const id = nextId++;
      shifts.push({
        id,
        worker: workerName,
        color,
        dayIndex,
        laneIndex,
        startSlot,
        endSlot,
        note: ''
      });

      renderShifts();
      scheduleAutoSave();
      const [startTime, endTime] = [slotToTime(startSlot), slotToTime(endSlot)];
      setStatus(`Torn creat: ${workerName} (${DAYS[dayIndex]} ${startTime} - ${endTime})`, false);
    }

    function hasOverlap(dayIndex, laneIndex, startSlot, endSlot, excludeId = null) {
      return shifts.some(s =>
        s.dayIndex === dayIndex &&
        s.laneIndex === laneIndex &&
        s.id !== excludeId &&
        !(endSlot <= s.startSlot || startSlot >= s.endSlot)
      );
    }

    function slotToTime(slot) {
      const totalMinutes = HOUR_START * 60 + slot * SLOT_MINUTES;
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;
      return `${String(h).padStart(2,'0')}:${m === 0 ? '00' : '30'}`;
    }

    function renderShifts() {
      const grid = document.getElementById('weekGrid');
      if (!grid) return;
      const oldBlocks = grid.querySelectorAll('.shift-block');
      oldBlocks.forEach(b => b.remove());

      const visible = shifts.filter(s => isWorkerSelected(s.worker));

      visible.forEach(shift => {
        const block = document.createElement('div');
        block.className = 'shift-block';
        if (editingShiftId === shift.id) block.classList.add('editing');

        const rowStart = 2 + shift.startSlot;
        const rowEnd = 2 + shift.endSlot;
        const col = 2 + shift.dayIndex * LANES_PER_DAY + shift.laneIndex;

        block.style.gridRow = `${rowStart} / ${rowEnd}`;
        block.style.gridColumn = String(col);
        block.style.borderColor = shift.color;
        block.style.backgroundColor = hexToRgba(shift.color, 0.18);

        const mainRow = document.createElement('div');
        mainRow.className = 'shift-main-row';

        const main = document.createElement('div');
        main.className = 'shift-main';
        const [startTime, endTime] = [slotToTime(shift.startSlot), slotToTime(shift.endSlot)];
        main.textContent = `${shift.worker} (${startTime} - ${endTime})`;
        mainRow.appendChild(main);

        const delBtn = document.createElement('button');
        delBtn.className = 'shift-del';
        delBtn.textContent = '‚úï';
        delBtn.title = 'Eliminar torn';
        delBtn.addEventListener('pointerdown', (e) => {
          e.stopPropagation();
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
        });
        delBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (editingShiftId === shift.id) exitEditMode();
          deleteShift(shift.id);
        });
        delBtn.style.pointerEvents = 'auto';
        mainRow.appendChild(delBtn);

        block.appendChild(mainRow);

        if (shift.note) {
          const noteDiv = document.createElement('div');
          noteDiv.className = 'shift-note';
          noteDiv.textContent = shift.note;
          block.appendChild(noteDiv);
        }

        if (isMobileDevice) {
          const handleTop = document.createElement('div');
          handleTop.className = 'edit-handle top';
          handleTop.textContent = '‚¨ç';
          handleTop.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
            startDragResize(shift.id, 'top');
          });
          handleTop.addEventListener('pointerdown', (e) => {
            if (e.pointerType === 'touch') return;
            e.stopPropagation();
            e.preventDefault();
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
            startDragResize(shift.id, 'top');
          });
          block.appendChild(handleTop);

          const handleBottom = document.createElement('div');
          handleBottom.className = 'edit-handle bottom';
          handleBottom.textContent = '‚¨ç';
          handleBottom.style.transform = 'translateX(-50%) rotate(180deg)';
          handleBottom.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
            startDragResize(shift.id, 'bottom');
          });
          handleBottom.addEventListener('pointerdown', (e) => {
            if (e.pointerType === 'touch') return;
            e.stopPropagation();
            e.preventDefault();
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
            startDragResize(shift.id, 'bottom');
          });
          block.appendChild(handleBottom);

          block.addEventListener('click', (e) => {
            if (e.target.classList.contains('shift-del')) return;
            if (e.target.classList.contains('edit-handle')) return;
            if (e.target.closest('.shift-del')) return;
            if (e.target.closest('.edit-handle')) return;
            
            e.stopPropagation();
            
            if (editingShiftId === shift.id) {
              editNoteForShift(shift.id);
            } else if (editingShiftId) {
              startEditMode(shift.id);
              if (navigator.vibrate) navigator.vibrate(30);
            } else {
              startEditMode(shift.id);
              if (navigator.vibrate) navigator.vibrate(50);
            }
          });
        } else {
          const handleTop = document.createElement('div');
          handleTop.className = 'handle top';
          handleTop.addEventListener('pointerdown', e => startResizeDesktop(e, shift.id, 'start'));
          block.appendChild(handleTop);

          const handleBottom = document.createElement('div');
          handleBottom.className = 'handle bottom';
          handleBottom.addEventListener('pointerdown', e => startResizeDesktop(e, shift.id, 'end'));
          block.appendChild(handleBottom);

          block.addEventListener('dblclick', () => {
            editNoteForShift(shift.id);
          });

          block.addEventListener('pointerdown', e => {
            if (e.target.classList.contains('handle') ||
                e.target.classList.contains('shift-del')) return;
            startMoveDesktop(e, shift.id);
          });
        }

        grid.appendChild(block);
      });

      updateSummary();
    }

    function startDragResize(shiftId, handlePosition) {
      const shift = shifts.find(s => s.id === shiftId);
      if (!shift) return;
      
      let isDragging = true;
      const grid = document.getElementById('weekGrid');
      const wrapper = grid.parentElement;
      
      const shiftBlock = Array.from(grid.querySelectorAll('.shift-block')).find(b => {
        const blockShift = shifts.find(s => {
          const rowStart = 2 + s.startSlot;
          const col = 2 + s.dayIndex * LANES_PER_DAY + s.laneIndex;
          return b.style.gridRow.startsWith(rowStart + '') && b.style.gridColumn === String(col) && s.id === shiftId;
        });
        return blockShift !== undefined;
      });
      
      const getClientY = (e) => {
        if (e.touches && e.touches.length > 0) {
          return e.touches[0].clientY;
        }
        return e.clientY;
      };
      
      const onMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        
        const clientY = getClientY(e);
        const rect = grid.getBoundingClientRect();
        const y = clientY - rect.top + wrapper.scrollTop;
        
        const row = Math.floor(y / slotHeightRuntime);
        let slotIndex = row - 1;
        
        if (slotIndex < 0) slotIndex = 0;
        if (slotIndex >= TOTAL_SLOTS) slotIndex = TOTAL_SLOTS - 1;
        
        let newStart = shift.startSlot;
        let newEnd = shift.endSlot;
        
        if (handlePosition === 'top') {
          newStart = slotIndex;
          if (newStart >= newEnd - 1) {
            newStart = newEnd - 1;
          }
          if (newStart < 0) newStart = 0;
        } else {
          newEnd = slotIndex + 1;
          if (newEnd <= newStart + 1) {
            newEnd = newStart + 1;
          }
          if (newEnd > TOTAL_SLOTS) newEnd = TOTAL_SLOTS;
        }
        
        if (newStart === shift.startSlot && newEnd === shift.endSlot) return;
        
        if (hasOverlap(shift.dayIndex, shift.laneIndex, newStart, newEnd, shift.id)) {
          return;
        }
        
        shift.startSlot = newStart;
        shift.endSlot = newEnd;
        
        if (shiftBlock) {
          const rowStart = 2 + shift.startSlot;
          const rowEnd = 2 + shift.endSlot;
          shiftBlock.style.gridRow = `${rowStart} / ${rowEnd}`;
          
          const mainDiv = shiftBlock.querySelector('.shift-main');
          if (mainDiv) {
            const [startTime, endTime] = [slotToTime(shift.startSlot), slotToTime(shift.endSlot)];
            mainDiv.textContent = `${shift.worker} (${startTime} - ${endTime})`;
          }
        }
      };
      
      const onEnd = () => {
        isDragging = false;
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', onEnd);
        document.removeEventListener('touchcancel', onEnd);
        document.removeEventListener('pointermove', onMove);
        document.removeEventListener('pointerup', onEnd);
        document.removeEventListener('pointercancel', onEnd);
        
        renderShifts();
        scheduleAutoSave();
        
        const [startTime, endTime] = [slotToTime(shift.startSlot), slotToTime(shift.endSlot)];
        const duration = shift.endSlot - shift.startSlot;
        setStatus(`Torn redimensionat: ${startTime} - ${endTime} (${formatHoursFromSlots(duration)})`, false);
      };
      
      document.addEventListener('touchmove', onMove, { passive: false });
      document.addEventListener('touchend', onEnd);
      document.addEventListener('touchcancel', onEnd);
      
      document.addEventListener('pointermove', onMove);
      document.addEventListener('pointerup', onEnd);
      document.addEventListener('pointercancel', onEnd);
    }

    function clearShifts() {
      if (confirm('Vols netejar tots els torns d\'aquesta setmana?')) {
        shifts = [];
        renderShifts();
        scheduleAutoSave();
        setStatus('S\'han esborrat els torns.', false);
      }
    }

    function deleteShift(id) {
      shifts = shifts.filter(s => s.id !== id);
      renderShifts();
      scheduleAutoSave();
    }

    function editNoteForShift(id) {
      const shift = shifts.find(s => s.id === id);
      if (!shift) return;
      const text = prompt('Nota per al torn de ' + shift.worker, shift.note || '');
      if (text === null) return;
      shift.note = text.trim();
      renderShifts();
      scheduleAutoSave();
    }

    function startResizeDesktop(e, id, side) {
      e.preventDefault();
      e.stopPropagation();
      resizing = { id, side };
      moving = null;
    }

    function startMoveDesktop(e, id) {
      e.preventDefault();
      e.stopPropagation();
      const shift = shifts.find(s => s.id === id);
      if (!shift) return;
      resizing = null;

      const grid = document.getElementById('weekGrid');
      const rect = grid.getBoundingClientRect();
      const y = e.clientY - rect.top;
      const row = Math.floor(y / slotHeightRuntime);

      const slotIndex = row - 1;
      const offsetSlots = slotIndex - shift.startSlot;

      moving = { id, offsetSlots };
      renderShifts();
    }

    function handleResizeMoveDesktop(e) {
      const grid = document.getElementById('weekGrid');
      const rect = grid.getBoundingClientRect();
      let y = e.clientY - rect.top;

      let row = Math.floor(y / slotHeightRuntime);
      let slotIndex = row - 1;
      if (slotIndex < 0) slotIndex = 0;
      if (slotIndex > TOTAL_SLOTS - 1) slotIndex = TOTAL_SLOTS - 1;

      const shift = shifts.find(s => s.id === resizing.id);
      if (!shift) return;

      let newStart = shift.startSlot;
      let newEnd = shift.endSlot;

      if (resizing.side === 'start') {
        newStart = slotIndex;
        if (newStart >= newEnd) newStart = newEnd - 1;
        if (newEnd - newStart < MIN_SLOTS_RESIZE) newStart = newEnd - MIN_SLOTS_RESIZE;
        if (newStart < 0) newStart = 0;
      } else {
        newEnd = slotIndex + 1;
        if (newEnd <= newStart) newEnd = newStart + 1;
        if (newEnd - newStart < MIN_SLOTS_RESIZE) newEnd = newStart + MIN_SLOTS_RESIZE;
        if (newEnd > TOTAL_SLOTS) newEnd = TOTAL_SLOTS;
      }

      if (hasOverlap(shift.dayIndex, shift.laneIndex, newStart, newEnd, shift.id)) return;

      shift.startSlot = newStart;
      shift.endSlot = newEnd;
      renderShifts();
    }

    function handleMoveShiftDesktop(e) {
      const grid = document.getElementById('weekGrid');
      const rect = grid.getBoundingClientRect();
      let y = e.clientY - rect.top;

      let row = Math.floor(y / slotHeightRuntime);
      let slotIndex = row - 1;
      if (slotIndex < 0) slotIndex = 0;
      if (slotIndex > TOTAL_SLOTS - 1) slotIndex = TOTAL_SLOTS - 1;

      const shift = shifts.find(s => s.id === moving.id);
      if (!shift) return;

      const duration = shift.endSlot - shift.startSlot;
      let newStart = slotIndex - moving.offsetSlots;
      if (newStart < 0) newStart = 0;
      let newEnd = newStart + duration;
      if (newEnd > TOTAL_SLOTS) {
        newEnd = TOTAL_SLOTS;
        newStart = newEnd - duration;
        if (newStart < 0) newStart = 0;
      }

      let targetDay = shift.dayIndex;
      let targetLane = shift.laneIndex;

      const el = document.elementFromPoint(e.clientX, e.clientY);
      if (el) {
        const slotCell = el.classList.contains('slot-cell') ? el : el.closest('.slot-cell');
        if (slotCell) {
          targetDay = parseInt(slotCell.dataset.day, 10);
          targetLane = parseInt(slotCell.dataset.lane, 10);
        }
      }

      if (hasOverlap(targetDay, targetLane, newStart, newEnd, shift.id)) return;

      shift.startSlot = newStart;
      shift.endSlot = newEnd;
      shift.dayIndex = targetDay;
      shift.laneIndex = targetLane;

      renderShifts();
    }

    function startEditMode(shiftId) {
      editingShiftId = shiftId;
      renderShifts();
      
      const cells = document.querySelectorAll('.slot-cell');
      cells.forEach(cell => {
        cell.style.cursor = 'pointer';
        cell.style.background = '#dbeafe';
      });
      
      setStatus('‚úèÔ∏è MODE EDICI√ì: Toca casella per moure | Arrossega ‚¨ç per redimensionar | Toca torn per nota | Toca fora per sortir', false);
    }

    function exitEditMode() {
      editingShiftId = null;
      renderShifts();
      
      const cells = document.querySelectorAll('.slot-cell');
      cells.forEach(cell => {
        cell.style.cursor = '';
        cell.style.background = '';
        if (cell.classList.contains('holiday-slot')) {
          cell.style.background = '#fef2f2';
        }
      });
      
      setStatus('Mode edici√≥ desactivat', false);
    }

    function moveShiftToCell(dayIndex, laneIndex, slotIndex) {
      if (!editingShiftId) return;
      
      const shift = shifts.find(s => s.id === editingShiftId);
      if (!shift) return;
      
      const duration = shift.endSlot - shift.startSlot;
      const newStart = slotIndex;
      const newEnd = newStart + duration;
      
      if (newEnd > TOTAL_SLOTS) {
        setStatus('El torn no cap en aquesta posici√≥', true);
        return;
      }
      
      if (hasOverlap(dayIndex, laneIndex, newStart, newEnd, shift.id)) {
        setStatus('Ja hi ha un torn en aquesta franja', true);
        return;
      }
      
      shift.dayIndex = dayIndex;
      shift.laneIndex = laneIndex;
      shift.startSlot = newStart;
      shift.endSlot = newEnd;
      
      exitEditMode();
      scheduleAutoSave();
      setStatus('Torn mogut', false);
    }

    function onPointerMoveGlobal(e) {
      if (isMobileDevice) return;
      
      if (resizing) handleResizeMoveDesktop(e);
      else if (moving) handleMoveShiftDesktop(e);
    }

    function onPointerUpGlobal() {
      if (isMobileDevice) return;
      
      if (resizing || moving) {
        resizing = null;
        moving = null;
        renderShifts();
        scheduleAutoSave();
      }
      
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    }

    function copyWeek() {
      if (!currentWeekStart) {
        setStatus('No hi ha setmana carregada per copiar.', true);
        return;
      }
      copiedWeek = {
        weekStart: currentWeekStart,
        shifts: JSON.parse(JSON.stringify(shifts))
      };
      setStatus('Setmana copiada.', false);
    }

    function pasteWeek() {
      if (!copiedWeek || !copiedWeek.shifts || !copiedWeek.shifts.length) {
        setStatus('No hi ha cap setmana copiada.', true);
        return;
      }
      const ok = confirm('Substituir els torns?');
      if (!ok) return;

      shifts = JSON.parse(JSON.stringify(copiedWeek.shifts));
      let maxId = 0;
      shifts.forEach(s => { if (s.id && s.id > maxId) maxId = s.id; });
      nextId = maxId + 1;

      renderShifts();
      scheduleAutoSave();
      setStatus('Setmana enganxada.', false);
    }

    async function generateReport() {
      const from = document.getElementById('reportFrom')?.value;
      const to = document.getElementById('reportTo')?.value;

      if (!from || !to) {
        setStatus('Cal triar les dues dates.', true);
        return;
      }

      setStatus('Generant resum...', false);

      try {
        // Carregar tots els torns del rang
        const { data, error } = await supabaseClient
          .from('shifts')
          .select('*')
          .eq('user_id', currentUser.id)
          .gte('date', from)
          .lte('date', to)
          .order('date');

        if (error) throw error;

        if (!data || data.length === 0) {
          setStatus('No hi ha torns en aquest per√≠ode.', true);
          return;
        }

        // Generar resum
        const totals = {};
        data.forEach(s => {
          const [sh, sm] = s.start_time.split(':').map(Number);
          const [eh, em] = s.end_time.split(':').map(Number);
          const mins = (eh * 60 + em) - (sh * 60 + sm);
          
          if (!totals[s.worker_name]) {
            totals[s.worker_name] = 0;
          }
          totals[s.worker_name] += mins;
        });

        // Crear finestra amb el resum
        const reportHtml = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>Resum hores - ${from} a ${to}</title>
            <style>
              body { font-family: system-ui, sans-serif; padding: 40px; }
              h1 { color: #1f2937; }
              table { border-collapse: collapse; width: 100%; max-width: 600px; margin-top: 20px; }
              th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
              th { background: #f9fafb; font-weight: 600; }
              .hours { text-align: right; font-variant-numeric: tabular-nums; }
              .total { font-weight: 600; background: #dbeafe; }
              @media print { button { display: none; } }
            </style>
          </head>
          <body>
            <h1>Resum d'hores</h1>
            <p><strong>Per√≠ode:</strong> ${from} a ${to}</p>
            <table>
              <tr><th>Treballador</th><th class="hours">Hores</th></tr>
              ${Object.entries(totals)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([name, mins]) => `<tr><td>${name}</td><td class="hours">${formatHoursFromMinutes(mins)}</td></tr>`)
                .join('')}
              <tr class="total">
                <td>TOTAL</td>
                <td class="hours">${formatHoursFromMinutes(Object.values(totals).reduce((a, b) => a + b, 0))}</td>
              </tr>
            </table>
            <br><button onclick="window.print()">Imprimir / PDF</button>
          </body>
          </html>
        `;

        const win = window.open('', '_blank');
        win.document.write(reportHtml);
        win.document.close();

        setStatus('Resum generat.', false);
      } catch (error) {
        console.error('Error generant resum:', error);
        setStatus('Error generant resum: ' + error.message, true);
      }
    }

    function hexToRgba(hex, alpha) {
      let c = String(hex || '').replace('#','');
      if (c.length === 3) c = c.split('').map(ch => ch + ch).join('');
      const r = parseInt(c.slice(0,2) || '0',16);
      const g = parseInt(c.slice(2,4) || '0',16);
      const b = parseInt(c.slice(4,6) || '0',16);
      return `rgba(${r},${g},${b},${alpha})`;
    }
  </script>
</body>
</html>
