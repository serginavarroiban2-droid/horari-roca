<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HORARI ROCA ¬∑ Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ESTILS GENERALS */
    body { font-family: system-ui, sans-serif; margin: 0; background: #f3f4f6; }
    .hidden { display: none !important; }
    
    /* LOGIN */
    .login-screen { display: flex; align-items: center; justify-content: center; height: 100vh; background: #764ba2; }
    .login-box { background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; }

    /* BARRES DE NAVEGACI√ì */
    .user-bar { background: #1f2937; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    .admin-controls { background: #fff; padding: 15px 20px; border-bottom: 2px solid #e5e7eb; display: none; gap: 10px; align-items: center; }
    
    /* ROLS */
    .role-badge { font-size: 11px; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; margin-left: 10px; font-weight: bold; }
    .role-admin { background: #ef4444; color: white; }
    .role-encarregat { background: #f59e0b; color: white; }
    .role-treballador { background: #10b981; color: white; }

    /* FESTIUS */
    .holiday-slot { background: #fff5f5 !important; border: 1px solid #fecaca !important; }
    .holiday-alert { color: #ef4444; font-weight: bold; margin-left: 10px; font-size: 0.9em; }

    .btn { cursor: pointer; padding: 8px 15px; border-radius: 6px; border: none; font-weight: 600; }
    .btn-add { background: #10b981; color: white; }
    .btn-holiday { background: #ef4444; color: white; }
  </style>
</head>
<body>

  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <h2>üóìÔ∏è Horari Roca</h2>
      <form id="authForm">
        <input type="email" id="email" placeholder="Correu electr√≤nic" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
        <input type="password" id="password" placeholder="Contrasenya" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <button type="submit" class="btn" style="width: 100%; background: #1f2937; color: white;">Iniciar sessi√≥</button>
      </form>
    </div>
  </div>

  <div id="mainApp" class="hidden">
    <div class="user-bar">
      <div>
        <strong>Horari Roca</strong>
        <span id="userEmail" style="margin-left: 15px; opacity: 0.8;"></span>
        <span id="userRoleBadge" class="role-badge"></span>
      </div>
      <button onclick="logout()" class="btn" style="background: #374151; color: white; font-size: 12px;">Tancar sessi√≥</button>
    </div>

    <div id="adminPanel" class="admin-controls">
      <button class="btn btn-add" onclick="addNewWorker()">+ Afegir Treballador</button>
      <div style="margin-left: auto;">
        <input type="date" id="holidayPicker" style="padding: 7px; border: 1px solid #ccc; border-radius: 5px;">
        <button class="btn btn-holiday" onclick="handleHolidayToggle()">Marcar/Desmarcar Festiu</button>
      </div>
    </div>

    <div style="padding: 20px;">
      <div id="workersSection" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h3>Treballadors</h3>
        <div id="workersList">Carregant...</div>
      </div>
      
      <div id="scheduleGrid" style="background: white; padding: 20px; border-radius: 8px;">
        <p>Graella d'horaris (Mode: <strong id="currentRoleText"></strong>)</p>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://zwxismquyhyeufdmtgsw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3eGlzbXF1eWh5ZXVmZG10Z3N3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzYxODYsImV4cCI6MjA4MTkxMjE4Nn0.ewU3PFuJoW8UfaK6jZqvqjm9PJ0s5citTjd9Xuzypt0';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let userRole = 'treballador';

    // 1. GESTI√ì DE SESS√ì
    document.getElementById('authForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) alert("Error: " + error.message);
      else location.reload();
    });

    async function checkSession() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        currentUser = session.user;
        await loadRole();
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('userEmail').textContent = currentUser.email;
        loadWorkers();
      }
    }

    // 2. CARREGAR EL ROL (Admin, Encarregat, Treballador)
    async function loadRole() {
      const { data, error } = await supabaseClient
        .from('profiles')
        .select('role')
        .eq('id', currentUser.id)
        .single();
      
      if (data) {
        userRole = data.role;
        const badge = document.getElementById('userRoleBadge');
        badge.textContent = userRole;
        badge.className = `role-badge role-${userRole}`;
        document.getElementById('currentRoleText').textContent = userRole;
        
        if (userRole === 'admin') {
            document.getElementById('adminPanel').style.display = 'flex';
        }
      }
    }

    // 3. GESTI√ì DE TREBALLADORS
    async function loadWorkers() {
      const { data, error } = await supabaseClient.from('workers').select('*').eq('user_id', currentUser.id);
      const list = document.getElementById('workersList');
      list.innerHTML = '';
      if (data) {
        data.forEach(w => {
          const div = document.createElement('div');
          div.style.padding = "10px";
          div.style.marginBottom = "5px";
          div.style.borderLeft = `6px solid ${w.color}`;
          div.style.background = "#f9fafb";
          div.innerHTML = `<strong>${w.name}</strong> <span style="font-size:0.8em; color:#666; margin-left:10px;">${w.color}</span>`;
          list.appendChild(div);
        });
      }
    }

    async function addNewWorker() {
      if (userRole !== 'admin') return;
      const name = prompt("Nom del treballador:");
      const color = prompt("Color hexadecimal (ex: #3b82f6):", "#3b82f6");
      if (name && color) {
        await supabaseClient.from('workers').insert([{ name, color, user_id: currentUser.id }]);
        loadWorkers();
      }
    }

    // 4. FESTIUS
    async function handleHolidayToggle() {
      if (userRole !== 'admin') return;
      const date = document.getElementById('holidayPicker').value;
      if (!date) return alert("Tria una data");
      
      const { data } = await supabaseClient.from('holidays').select('*').eq('date', date).eq('user_id', currentUser.id);
      
      if (data && data.length > 0) {
        await supabaseClient.from('holidays').delete().eq('date', date);
        alert("Festiu eliminat");
      } else {
        await supabaseClient.from('holidays').insert([{ date, user_id: currentUser.id }]);
        alert("Festiu marcat");
      }
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      location.reload();
    }

    checkSession();
  </script>
</body>
</html>